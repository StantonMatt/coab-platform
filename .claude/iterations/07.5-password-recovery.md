# ITERATION 7.5: Self-Service Password Recovery (Secure via WhatsApp)

**Goal:** Customer can reset forgotten password without admin intervention

**Duration:** 1-2 days

**You'll Be Able To:** Complete secure password reset flow (6-digit code via WhatsApp)

**REVIEWER NOTE:** This prevents support overload on Day 1. Many customers will forget passwords.

**SECURITY:** Recovery codes sent via WhatsApp only (not returned in API responses). See Gemini 2.5 Pro security review for rationale.

---

## Backend Tasks (Day 1)

### Task 7.5.1: Password Reset Token System
**Time:** 3 hours

**Reuse:** `token_configuracion` table (already has `tipo` field from Iteration 1)

**Note:** No migration needed - `tipo` column supports both 'setup' and 'reset' values.

**Update:** `src/services/whatsapp.service.ts`

Add `sendRecoveryCode()` method (reuse existing Infobip client from Iteration 7):

```typescript
// src/services/whatsapp.service.ts
import { InfobipClient, AuthType } from '@infobip-api/sdk';

const client = new InfobipClient({
  baseUrl: process.env.INFOBIP_BASE_URL!,
  apiKey: process.env.INFOBIP_API_KEY!,
  authType: AuthType.ApiKey
});

// ... existing sendSetupLink function ...

export async function sendRecoveryCode(
  phoneNumber: string,
  customerName: string,
  recoveryCode: string,
  logger: any
) {
  // Format phone number for Chilean format (+56 9 XXXX XXXX)
  const formattedPhone = phoneNumber.startsWith('+56')
    ? phoneNumber
    : `+56${phoneNumber.replace(/^0/, '')}`;

  const message = `Hola ${customerName}! 🔐

Tu código de recuperación de contraseña para COAB es:

*${recoveryCode}*

Este código es válido por 15 minutos. No lo compartas con nadie.

Si no solicitaste este código, ignora este mensaje.`;

  try {
    const response = await client.channels.whatsapp.send({
      type: 'text',
      from: process.env.INFOBIP_WHATSAPP_SENDER!,
      to: formattedPhone,
      content: {
        text: message
      }
    });

    logger.info('WhatsApp recovery code sent via Infobip', {
      to: formattedPhone,
      messageId: response.messages?.[0]?.messageId,
      status: response.messages?.[0]?.status?.groupName
    });

    return {
      success: true,
      messageId: response.messages?.[0]?.messageId
    };
  } catch (error: any) {
    logger.error('Failed to send WhatsApp recovery code via Infobip', {
      to: formattedPhone,
      error: error.message,
      details: error.response?.data
    });

    throw new Error('No se pudo enviar código de recuperación por WhatsApp. Intente más tarde.');
  }
}
```

**Update:** `src/services/auth.service.ts`

Add `solicitarReset()` and `resetearPassword()` methods:

```typescript
// src/services/auth.service.ts
import { hash } from '@node-rs/argon2';
import { PrismaClient } from '@prisma/client';
import { sendRecoveryCode } from './whatsapp.service.js'; // Import WhatsApp service

const prisma = new PrismaClient();

export async function solicitarReset(rut: string, logger: any) {
  const rutLimpio = rut.replace(/[.-]/g, '');

  const cliente = await prisma.cliente.findUnique({
    where: { rut: rutLimpio },
    select: {
      id: true,
      rut: true,
      telefono: true,
      nombre_completo: true
    }
  });

  // Security: Same response whether found or not (prevent enumeration)
  if (!cliente || !cliente.telefono) {
    logger.warn('Password reset requested for non-existent or invalid RUT', {
      rut: rutLimpio.substring(0, 4) + '...'
    });
    return {
      message: 'Si el RUT existe y tiene teléfono registrado, recibirá un código por WhatsApp'
    };
  }

  // Generate 6-digit code
  const codigo = Math.floor(100000 + Math.random() * 900000).toString();

  await prisma.token_configuracion.create({
    data: {
      cliente_id: cliente.id,
      token: codigo,
      tipo: 'reset',
      expira_en: new Date(Date.now() + 15 * 60 * 1000), // 15 minutes
      usado: false
    }
  });

  logger.info('Password reset code generated', {
    clienteId: cliente.id.toString(),
    telefono: cliente.telefono.substring(0, 6) + '...',
    expiry: '15min'
  });

  // **SECURE: Send code via WhatsApp instead of returning it**
  try {
    await sendRecoveryCode(cliente.telefono, cliente.nombre_completo, codigo, logger);

    return {
      message: 'Código de recuperación enviado a su WhatsApp'
      // SECURE: Code NOT returned in response
    };
  } catch (whatsappError: any) {
    // WhatsApp failed, but don't reveal to user (security)
    logger.error('WhatsApp recovery code send failed', {
      clienteId: cliente.id.toString(),
      error: whatsappError.message
    });

    // Still return success to prevent user enumeration
    return {
      message: 'Si el RUT existe y tiene teléfono registrado, recibirá un código por WhatsApp'
    };
  }
}

export async function resetearPassword(
  rut: string,
  codigo: string,
  nuevaPassword: string,
  logger: any
) {
  const rutLimpio = rut.replace(/[.-]/g, '');

  const token = await prisma.token_configuracion.findFirst({
    where: {
      token: codigo,
      tipo: 'reset',
      usado: false,
      expira_en: { gt: new Date() }
    },
    include: {
      cliente: {
        select: {
          id: true,
          rut: true,
          nombre_completo: true
        }
      }
    }
  });

  if (!token || token.cliente.rut !== rutLimpio) {
    logger.warn('Invalid password reset attempt', {
      rut: rutLimpio.substring(0, 4) + '...',
      codigo: codigo.substring(0, 2) + '...'
    });
    throw new Error('Código inválido o expirado');
  }

  // Hash password with Argon2id
  const hashContrasena = await hash(nuevaPassword, {
    memoryCost: 19456, // 19 MiB
    timeCost: 2,
    parallelism: 1
  });

  // Update password and unlock account if locked
  await prisma.cliente.update({
    where: { id: token.cliente_id },
    data: {
      hash_contrasena: hashContrasena,
      cuenta_bloqueada: false, // Unlock if locked
      intentos_fallidos: 0,
      bloqueada_hasta: null
    }
  });

  // Mark token used
  await prisma.token_configuracion.update({
    where: { id: token.id },
    data: {
      usado: true,
      usado_en: new Date()
    }
  });

  logger.info('Password reset successful', {
    clienteId: token.cliente_id.toString(),
    wasLocked: token.cliente.cuenta_bloqueada
  });

  return {
    message: 'Contraseña actualizada exitosamente',
    cliente: {
      rut: token.cliente.rut,
      nombre: token.cliente.nombre_completo
    }
  };
}
```

**Update:** `src/routes/auth.routes.ts`

Add reset endpoints:

```typescript
// src/routes/auth.routes.ts
import { FastifyPluginAsync } from 'fastify';
import { z } from 'zod';
import * as authService from '../services/auth.service.js';
import { validarRUT } from '../utils/validators.js';

const solicitarResetSchema = z.object({
  rut: z.string().min(1, 'RUT requerido')
});

const resetearPasswordSchema = z.object({
  rut: z.string().min(1, 'RUT requerido'),
  codigo: z.string().length(6, 'Código debe tener 6 dígitos'),
  nuevaPassword: z.string()
    .min(8, 'Contraseña debe tener al menos 8 caracteres')
    .regex(/[0-9]/, 'Contraseña debe contener al menos un número')
});

const authRoutes: FastifyPluginAsync = async (fastify) => {
  // POST /auth/solicitar-reset
  fastify.post('/solicitar-reset', async (request, reply) => {
    try {
      const body = solicitarResetSchema.parse(request.body);

      if (!validarRUT(body.rut)) {
        return reply.code(400).send({
          error: { code: 'INVALID_RUT', message: 'RUT inválido' }
        });
      }

      const result = await authService.solicitarReset(body.rut, fastify.log);
      return result;
    } catch (error: any) {
      if (error.name === 'ZodError') {
        return reply.code(400).send({
          error: {
            code: 'VALIDATION_ERROR',
            message: error.errors[0].message
          }
        });
      }
      throw error;
    }
  });

  // POST /auth/resetear-password
  fastify.post('/resetear-password', async (request, reply) => {
    try {
      const body = resetearPasswordSchema.parse(request.body);

      if (!validarRUT(body.rut)) {
        return reply.code(400).send({
          error: { code: 'INVALID_RUT', message: 'RUT inválido' }
        });
      }

      const result = await authService.resetearPassword(
        body.rut,
        body.codigo,
        body.nuevaPassword,
        fastify.log
      );

      return result;
    } catch (error: any) {
      if (error.name === 'ZodError') {
        return reply.code(400).send({
          error: {
            code: 'VALIDATION_ERROR',
            message: error.errors[0].message
          }
        });
      }
      if (error.message.includes('inválido') || error.message.includes('expirado')) {
        return reply.code(400).send({
          error: { code: 'INVALID_CODE', message: error.message }
        });
      }
      throw error;
    }
  });
};

export default authRoutes;
```

**Test:**
```bash
# Request reset code (sends to WhatsApp)
curl -X POST http://localhost:3000/api/v1/auth/solicitar-reset \
  -H "Content-Type: application/json" \
  -d '{"rut":"12345678-9"}'

# Returns:
# {
#   "message": "Código de recuperación enviado a su WhatsApp"
# }
# **SECURE:** Code NOT returned in response. User receives it via WhatsApp.

# Check customer's WhatsApp for the 6-digit code
# OR check backend logs for the code (development only):
# grep "Password reset code generated" logs/app.log

# Reset password with code from WhatsApp
curl -X POST http://localhost:3000/api/v1/auth/resetear-password \
  -H "Content-Type: application/json" \
  -d '{
    "rut": "12345678-9",
    "codigo": "123456",
    "nuevaPassword": "NewPass456"
  }'

# Returns:
# {
#   "message": "Contraseña actualizada exitosamente",
#   "cliente": {
#     "rut": "12345678-9",
#     "nombre": "Juan Pérez"
#   }
# }
```

**Development Testing (without Infobip):**

If Infobip is not yet configured, you can temporarily log the code to console for testing:

```typescript
// TEMPORARY: For development only (REMOVE in production)
logger.info('[DEV ONLY] Reset code for testing', {
  clienteId: cliente.id.toString(),
  codigo // Log code for manual testing
});
```

**Acceptance Criteria:**
- [ ] Customer can request reset code by RUT
- [ ] Code is 6 digits
- [ ] Code expires after 15 minutes
- [ ] Invalid/expired code rejected
- [ ] Password updated successfully with Argon2id
- [ ] Account unlocked if locked
- [ ] Security: Same response whether RUT exists or not
- [ ] Pino logs show reset requests and successes

---

## Frontend Tasks (Day 1)

### Task 7.5.2: Password Reset Flow
**Time:** 3 hours

**Create:** `src/pages/PasswordRecovery.tsx`

```typescript
import { useState } from 'react';
import { useNavigate } from 'react-router';
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';
import apiClient from '@/lib/api';
import { formatearRUT, validarRUT } from '@/lib/utils';

const rutSchema = z.object({
  rut: z.string().min(1, 'RUT requerido').refine(validarRUT, 'RUT inválido')
});

const resetSchema = z.object({
  codigo: z.string().length(6, 'Código debe tener 6 dígitos'),
  nuevaPassword: z.string()
    .min(8, 'Contraseña debe tener al menos 8 caracteres')
    .regex(/[0-9]/, 'Contraseña debe contener al menos un número'),
  passwordConfirm: z.string()
}).refine((data) => data.nuevaPassword === data.passwordConfirm, {
  message: 'Las contraseñas no coinciden',
  path: ['passwordConfirm']
});

type RutForm = z.infer<typeof rutSchema>;
type ResetForm = z.infer<typeof resetSchema>;

export default function PasswordRecoveryPage() {
  const [step, setStep] = useState<'rut' | 'codigo' | 'success'>('rut');
  const [rut, setRut] = useState('');
  const [rutDisplay, setRutDisplay] = useState('');
  const navigate = useNavigate();
  const { toast } = useToast();

  const {
    register: registerRut,
    handleSubmit: handleSubmitRut,
    formState: { errors: errorsRut, isSubmitting: isSubmittingRut }
  } = useForm<RutForm>({
    resolver: zodResolver(rutSchema)
  });

  const {
    register: registerReset,
    handleSubmit: handleSubmitReset,
    watch,
    formState: { errors: errorsReset, isSubmitting: isSubmittingReset }
  } = useForm<ResetForm>({
    resolver: zodResolver(resetSchema)
  });

  const password = watch('nuevaPassword');

  const onSubmitRut = async (data: RutForm) => {
    try {
      const response = await apiClient.post('/auth/solicitar-reset', {
        rut: data.rut
      });

      setRut(data.rut);

      toast({
        title: 'Código enviado',
        description: response.data.message,
        duration: 5000
      });

      // **SECURE:** Code sent via WhatsApp, not returned in API response

      setStep('codigo');
    } catch (error: any) {
      const errorMessage = error.response?.data?.error?.message || 'Error al solicitar código';
      toast({
        variant: 'destructive',
        title: 'Error',
        description: errorMessage
      });
    }
  };

  const onSubmitReset = async (data: ResetForm) => {
    try {
      const response = await apiClient.post('/auth/resetear-password', {
        rut,
        codigo: data.codigo,
        nuevaPassword: data.nuevaPassword
      });

      toast({
        title: '¡Contraseña actualizada!',
        description: response.data.message
      });

      setStep('success');
    } catch (error: any) {
      const errorMessage = error.response?.data?.error?.message || 'Error al resetear contraseña';
      toast({
        variant: 'destructive',
        title: 'Error',
        description: errorMessage
      });
    }
  };

  if (step === 'rut') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <Card className="w-full max-w-md">
          <CardHeader>
            <CardTitle className="text-center text-2xl">Recuperar Contraseña</CardTitle>
            <p className="text-center text-sm text-gray-600 mt-2">
              Ingresa tu RUT para recibir un código de recuperación
            </p>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmitRut(onSubmitRut)} className="space-y-4">
              <div>
                <Label htmlFor="rut">RUT</Label>
                <Input
                  id="rut"
                  type="text"
                  inputMode="numeric"
                  placeholder="12.345.678-9"
                  value={rutDisplay}
                  onChange={(e) => {
                    const formatted = formatearRUT(e.target.value);
                    setRutDisplay(formatted);
                    registerRut('rut').onChange({
                      target: { value: formatted, name: 'rut' }
                    });
                  }}
                  onBlur={registerRut('rut').onBlur}
                  name={registerRut('rut').name}
                  ref={registerRut('rut').ref}
                  className={errorsRut.rut ? 'border-red-500' : ''}
                />
                {errorsRut.rut && (
                  <p className="text-sm text-red-500 mt-1">{errorsRut.rut.message}</p>
                )}
              </div>

              <Button type="submit" className="w-full" disabled={isSubmittingRut}>
                {isSubmittingRut ? 'Enviando...' : 'Enviar Código'}
              </Button>

              <Button
                type="button"
                variant="outline"
                className="w-full"
                onClick={() => navigate('/login')}
              >
                Volver al Login
              </Button>
            </form>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (step === 'codigo') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <Card className="w-full max-w-md">
          <CardHeader>
            <CardTitle className="text-center text-2xl">Ingresa el Código</CardTitle>
            <p className="text-center text-sm text-gray-600 mt-2">
              Revisa el código enviado a tu WhatsApp
            </p>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmitReset(onSubmitReset)} className="space-y-4">
              <div>
                <Label htmlFor="codigo">Código (6 dígitos)</Label>
                <Input
                  id="codigo"
                  type="text"
                  inputMode="numeric"
                  maxLength={6}
                  placeholder="123456"
                  {...registerReset('codigo')}
                  className={errorsReset.codigo ? 'border-red-500' : ''}
                />
                {errorsReset.codigo && (
                  <p className="text-sm text-red-500 mt-1">{errorsReset.codigo.message}</p>
                )}
              </div>

              <div>
                <Label htmlFor="nuevaPassword">Nueva Contraseña</Label>
                <Input
                  id="nuevaPassword"
                  type="password"
                  placeholder="Mínimo 8 caracteres, 1 número"
                  {...registerReset('nuevaPassword')}
                  className={errorsReset.nuevaPassword ? 'border-red-500' : ''}
                />
                {errorsReset.nuevaPassword && (
                  <p className="text-sm text-red-500 mt-1">{errorsReset.nuevaPassword.message}</p>
                )}
                {password && password.length > 0 && (
                  <div className="mt-2 text-sm space-y-1">
                    <p className={password.length >= 8 ? 'text-green-600' : 'text-gray-500'}>
                      {password.length >= 8 ? '✓' : '○'} Mínimo 8 caracteres
                    </p>
                    <p className={/[0-9]/.test(password) ? 'text-green-600' : 'text-gray-500'}>
                      {/[0-9]/.test(password) ? '✓' : '○'} Al menos 1 número
                    </p>
                  </div>
                )}
              </div>

              <div>
                <Label htmlFor="passwordConfirm">Confirmar Contraseña</Label>
                <Input
                  id="passwordConfirm"
                  type="password"
                  placeholder="Repite la contraseña"
                  {...registerReset('passwordConfirm')}
                  className={errorsReset.passwordConfirm ? 'border-red-500' : ''}
                />
                {errorsReset.passwordConfirm && (
                  <p className="text-sm text-red-500 mt-1">{errorsReset.passwordConfirm.message}</p>
                )}
              </div>

              <Button type="submit" className="w-full" disabled={isSubmittingReset}>
                {isSubmittingReset ? 'Actualizando...' : 'Cambiar Contraseña'}
              </Button>

              <Button
                type="button"
                variant="ghost"
                className="w-full text-sm"
                onClick={() => setStep('rut')}
              >
                ¿No recibiste el código? Intentar de nuevo
              </Button>
            </form>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
      <Card className="w-full max-w-md">
        <CardContent className="pt-6 text-center space-y-4">
          <div className="text-6xl text-green-600">✓</div>
          <h1 className="text-2xl font-bold text-green-600">Contraseña Actualizada</h1>
          <p className="text-gray-600">
            Tu contraseña ha sido actualizada exitosamente. Ya puedes iniciar sesión.
          </p>
          <Button className="w-full" onClick={() => navigate(`/login?rut=${encodeURIComponent(rut)}`)}>
            Ir a Inicio de Sesión
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Update:** `src/pages/Login.tsx` - Add "¿Olvidó su contraseña?" link

```typescript
// Add to Login.tsx below password field
<div className="text-right">
  <a
    href="/recuperar"
    className="text-sm text-primary-blue hover:underline"
  >
    ¿Olvidó su contraseña?
  </a>
</div>
```

**Update Router:**
```typescript
// src/main.tsx or App.tsx
import { createBrowserRouter, RouterProvider } from 'react-router';
import PasswordRecovery from './pages/PasswordRecovery';

const router = createBrowserRouter([
  {
    path: '/recuperar',
    element: <PasswordRecovery />
  }
]);
```

**Test:**
1. Go to `/login`
2. Click "¿Olvidó su contraseña?"
3. Should navigate to `/recuperar`
4. Enter RUT "12.345.678-9"
5. Click "Enviar Código"
6. **Check WhatsApp** for the 6-digit code (sent via Infobip)
   - OR check backend logs: `grep "Password reset code generated" logs/app.log`
7. Enter code received via WhatsApp (e.g., "123456")
8. Enter new password "NewPass456"
9. Enter confirm "NewPass456"
10. Should see real-time password validation
11. Click "Cambiar Contraseña"
12. Should see success screen
13. Click "Ir a Inicio de Sesión"
14. Should redirect to login with RUT pre-filled
15. Login with new password
16. Should successfully enter dashboard

**Acceptance Criteria:**
- [ ] Customer can request reset code by RUT
- [ ] **Code sent via WhatsApp (not returned in API response)** ✅ **SECURE**
- [ ] Code expires after 15 minutes
- [ ] Invalid/expired code shows error
- [ ] Password validation with real-time feedback
- [ ] Password updated successfully
- [ ] Account unlocked if locked
- [ ] Security: Same response whether RUT exists or not (prevents user enumeration)
- [ ] Link visible on login page
- [ ] Success redirects to login with RUT pre-filled
- [ ] Real-time password strength indicators
- [ ] "¿No recibiste el código?" link to restart flow
- [ ] WhatsApp message includes security warning ("No lo compartas con nadie")
- [ ] Failed WhatsApp send logs error but doesn't reveal to user (security)

---

## Iteration 7.5 Complete! ✅

**What You Can Test:**
- Complete self-service password reset via WhatsApp
- Customer can recover access without admin help
- Reduces support volume on launch day
- Works even if account is locked (gets unlocked)
- **Secure implementation:** Code sent via WhatsApp, not exposed in API

**Security Features:**
- ✅ Code delivered via WhatsApp (2FA-like security)
- ✅ No code exposure in API responses
- ✅ User enumeration prevention (same response for valid/invalid RUTs)
- ✅ 15-minute code expiry
- ✅ One-time use tokens (cannot reuse code)
- ✅ WhatsApp failure doesn't reveal customer existence

**Commit Message:**
```
feat: secure self-service password recovery via WhatsApp

Backend (Fastify + Argon2id + Infobip):
- Password reset token generation (POST /auth/solicitar-reset)
- 6-digit code with 15-minute expiry
- **SECURE:** Code sent via WhatsApp (not returned in API response)
- Infobip WhatsApp integration (sendRecoveryCode service)
- Password update endpoint (POST /auth/resetear-password)
- Account unlock on reset
- Argon2id password hashing
- User enumeration prevention (same response for valid/invalid RUTs)
- WhatsApp send failure doesn't reveal customer existence
- Pino logging for security audit

Frontend (Vite + React Router):
- Password recovery flow (3 steps: RUT → Code → New Password)
- Real-time password validation with checkmarks
- Link from login page
- Success redirect to login with RUT pre-filled
- Error handling for invalid/expired codes
- "Restart flow" button if code not received
- **SECURE:** No code display (user receives via WhatsApp)

Security improvements:
- Code delivered via WhatsApp (2FA-like security)
- No API response exposure of sensitive codes
- User enumeration attack prevention
- One-time use tokens with expiry
```
