# ITERATION 7.5: Self-Service Password Recovery

**Goal:** Customers can reset their own password via WhatsApp 6-digit code

**You'll Be Able To:** Request password reset, receive WhatsApp code, set new password - all without admin help

**Why This Matters:** Without self-service recovery, every "I forgot my password" becomes a support ticket for your small team. This iteration eliminates that bottleneck.

**Prerequisites:**
- Iteration 2 complete (customer auth working)
- Iteration 7 complete (Infobip integration working)

---

## Backend Tasks

### Task 7.5.1: Reset Request Endpoint with Security Protections

**Security Requirements:**
1. **Rate limiting:** Prevent WhatsApp spam and cost attacks
2. **Brute force protection:** Track failed code attempts per token
3. **Timing attack mitigation:** Consistent response time prevents RUT enumeration
4. **Short code expiry:** 15 minutes for 6-digit codes

**Update:** `src/services/auth.service.ts`

Add `solicitarReset()` and `validarCodigoReset()` methods:

> **Note:** The `infobip.service.ts` file referenced below was created in Iteration 7 (Task 7.2).

```typescript
// src/services/auth.service.ts
import { hash } from '@node-rs/argon2';
import { sendWhatsAppMessage, formatChileanPhone } from './infobip.service.js';

/**
 * Request password reset - generates 6-digit code sent via WhatsApp
 */
export async function solicitarReset(rut: string, ipAddress: string, logger: any) {
  const rutLimpio = rut.replace(/[.\-\s]/g, '').toUpperCase();

  // Start timing for consistent response time
  const startTime = Date.now();
  const MINIMUM_RESPONSE_TIME = 1500; // 1.5 seconds minimum

  try {
    const cliente = await prisma.cliente.findUnique({
      where: { rut: rutLimpio },
      select: {
        id: true,
        rut: true,
        nombre_completo: true,
        telefono: true,
        hash_contrasena: true
      }
    });

    // SECURITY: Don't reveal if RUT exists - consistent response
    if (!cliente || !cliente.telefono || !cliente.hash_contrasena) {
      // Wait to match normal processing time (timing attack mitigation)
      await waitUntil(startTime, MINIMUM_RESPONSE_TIME);
      
      logger.info('Password reset requested for non-existent/invalid customer', {
        rutPartial: rutLimpio.slice(0, 4) + '****',
        reason: !cliente ? 'not_found' : !cliente.telefono ? 'no_phone' : 'no_password'
      });

      // Return generic success to prevent RUT enumeration
      return {
        success: true,
        message: 'Si el RUT existe y tiene tel√©fono registrado, recibir√°s un c√≥digo por WhatsApp'
      };
    }

    // Delete any existing unused reset tokens for this customer
    await prisma.tokenConfiguracion.deleteMany({
      where: {
        cliente_id: cliente.id,
        tipo: 'reset',
        usado: false
      }
    });

    // Generate 6-digit code
    const codigo = String(Math.floor(100000 + Math.random() * 900000));

    // Create reset token (15 minute expiry, 5 max attempts)
    const tokenRecord = await prisma.tokenConfiguracion.create({
      data: {
        cliente_id: cliente.id,
        token: codigo,
        tipo: 'reset',
        usado: false,
        expira_en: new Date(Date.now() + 15 * 60 * 1000), // 15 minutes
        ip_creacion: ipAddress
      }
    });

    // Send WhatsApp message
    const mensaje = `COAB - C√≥digo de recuperaci√≥n

Tu c√≥digo es: ${codigo}

Este c√≥digo expira en 15 minutos.

Si no solicitaste este c√≥digo, ignora este mensaje.`;

    const whatsappResult = await sendWhatsAppMessage(cliente.telefono, mensaje);

    if (!whatsappResult.success) {
      logger.warn('Failed to send WhatsApp reset code', {
        clienteId: cliente.id.toString(),
        error: whatsappResult.error
      });
    }

    // Audit log
    await prisma.logAuditoria.create({
      data: {
        accion: 'SOLICITAR_RESET',
        entidad: 'cliente',
        entidad_id: cliente.id,
        usuario_tipo: 'cliente',
        datos_nuevos: {
          tokenExpiry: tokenRecord.expira_en.toISOString(),
          whatsappSent: whatsappResult.success
        },
        ip_address: ipAddress
      }
    });

    logger.info('Password reset code sent', {
      clienteId: cliente.id.toString(),
      rutPartial: rutLimpio.slice(0, 4) + '****',
      whatsappSuccess: whatsappResult.success
    });

    // Wait to match minimum response time
    await waitUntil(startTime, MINIMUM_RESPONSE_TIME);

    return {
      success: true,
      message: 'Si el RUT existe y tiene tel√©fono registrado, recibir√°s un c√≥digo por WhatsApp'
    };
  } catch (error: any) {
    logger.error('Password reset request failed', {
      rutPartial: rutLimpio.slice(0, 4) + '****',
      error: error.message
    });

    // Wait to match minimum response time
    await waitUntil(startTime, MINIMUM_RESPONSE_TIME);

    throw error;
  }
}

/**
 * Validate reset code and allow password change
 */
export async function validarCodigoReset(
  rut: string,
  codigo: string,
  nuevaContrasena: string,
  ipAddress: string,
  logger: any
) {
  const rutLimpio = rut.replace(/[.\-\s]/g, '').toUpperCase();

  const cliente = await prisma.cliente.findUnique({
    where: { rut: rutLimpio },
    select: { id: true, rut: true }
  });

  if (!cliente) {
    throw new Error('C√≥digo inv√°lido o expirado');
  }

  // Find valid reset token
  const tokenRecord = await prisma.tokenConfiguracion.findFirst({
    where: {
      cliente_id: cliente.id,
      token: codigo,
      tipo: 'reset',
      usado: false,
      expira_en: { gt: new Date() }
    }
  });

  if (!tokenRecord) {
    // Track failed attempt in audit log
    await prisma.logAuditoria.create({
      data: {
        accion: 'RESET_CODIGO_INVALIDO',
        entidad: 'cliente',
        entidad_id: cliente.id,
        usuario_tipo: 'cliente',
        datos_nuevos: {
          codigoIntentado: codigo.slice(0, 2) + '****'
        },
        ip_address: ipAddress
      }
    });

    logger.warn('Invalid reset code attempt', {
      clienteId: cliente.id.toString(),
      rutPartial: rutLimpio.slice(0, 4) + '****'
    });

    throw new Error('C√≥digo inv√°lido o expirado');
  }

  // Check for brute force (max 5 attempts per token)
  const recentFailedAttempts = await prisma.logAuditoria.count({
    where: {
      accion: 'RESET_CODIGO_INVALIDO',
      entidad_id: cliente.id,
      creado_en: {
        gte: new Date(Date.now() - 15 * 60 * 1000) // Last 15 minutes
      }
    }
  });

  if (recentFailedAttempts >= 5) {
    // Invalidate the token
    await prisma.tokenConfiguracion.update({
      where: { id: tokenRecord.id },
      data: { usado: true }
    });

    logger.warn('Reset token locked due to too many failed attempts', {
      clienteId: cliente.id.toString()
    });

    throw new Error('Demasiados intentos fallidos. Solicita un nuevo c√≥digo.');
  }

  // Code is valid - hash new password with Argon2id
  const hashContrasena = await hash(nuevaContrasena, {
    memoryCost: 19456,
    timeCost: 2,
    parallelism: 1
  });

  // Update password and mark token as used
  await prisma.$transaction([
    prisma.cliente.update({
      where: { id: cliente.id },
      data: {
        hash_contrasena: hashContrasena,
        cuenta_bloqueada: false, // Unlock if was locked
        intentos_fallidos: 0,
        bloqueada_hasta: null
      }
    }),
    prisma.tokenConfiguracion.update({
      where: { id: tokenRecord.id },
      data: {
        usado: true,
        usado_en: new Date(),
        ip_uso: ipAddress
      }
    })
  ]);

  // Audit log
  await prisma.logAuditoria.create({
    data: {
      accion: 'RESET_CONTRASENA_EXITOSO',
      entidad: 'cliente',
      entidad_id: cliente.id,
      usuario_tipo: 'cliente',
      datos_nuevos: {
        reset_completado: true
      },
      ip_address: ipAddress
    }
  });

  // Invalidate all refresh sessions for security
  await prisma.sesionRefresh.deleteMany({
    where: { cliente_id: cliente.id }
  });

  logger.info('Password reset completed successfully', {
    clienteId: cliente.id.toString(),
    rutPartial: rutLimpio.slice(0, 4) + '****'
  });

  return {
    success: true,
    message: 'Contrase√±a actualizada exitosamente',
    rut: cliente.rut
  };
}

// Helper function for consistent timing
async function waitUntil(startTime: number, minimumMs: number) {
  const elapsed = Date.now() - startTime;
  if (elapsed < minimumMs) {
    await new Promise(resolve => setTimeout(resolve, minimumMs - elapsed));
  }
}
```

**Update:** `src/routes/auth.routes.ts`

Add recovery endpoints with rate limiting:

```typescript
// Add to src/routes/auth.routes.ts

// POST /auth/solicitar-reset - Request password reset code
fastify.post('/solicitar-reset', {
  config: {
    rateLimit: {
      max: 3,
      timeWindow: '15 minutes',
      keyGenerator: (req) => {
        // Rate limit by RUT to prevent spam
        const body = req.body as any;
        const rutLimpio = (body?.rut || '').replace(/[.\-\s]/g, '').toUpperCase();
        return `reset-${rutLimpio}`;
      }
    }
  }
}, async (request, reply) => {
  try {
    const body = z.object({
      rut: z.string().min(1, 'RUT requerido')
    }).parse(request.body);

    const result = await authService.solicitarReset(
      body.rut,
      request.ip,
      fastify.log
    );

    return result;
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return reply.code(400).send({
        error: { code: 'VALIDATION_ERROR', message: error.errors[0].message }
      });
    }

    // Return generic success to prevent enumeration
    return {
      success: true,
      message: 'Si el RUT existe y tiene tel√©fono registrado, recibir√°s un c√≥digo por WhatsApp'
    };
  }
});

// POST /auth/validar-reset - Validate code and set new password
fastify.post('/validar-reset', {
  config: {
    rateLimit: {
      max: 10,
      timeWindow: '15 minutes',
      keyGenerator: (req) => {
        const body = req.body as any;
        const rutLimpio = (body?.rut || '').replace(/[.\-\s]/g, '').toUpperCase();
        return `validate-${rutLimpio}`;
      }
    }
  }
}, async (request, reply) => {
  try {
    const body = z.object({
      rut: z.string().min(1, 'RUT requerido'),
      codigo: z.string().length(6, 'C√≥digo debe ser de 6 d√≠gitos'),
      password: passwordSchema,
      confirmPassword: z.string()
    }).refine((data) => data.password === data.confirmPassword, {
      message: 'Las contrase√±as no coinciden',
      path: ['confirmPassword']
    }).parse(request.body);

    const result = await authService.validarCodigoReset(
      body.rut,
      body.codigo,
      body.password,
      request.ip,
      fastify.log
    );

    return result;
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return reply.code(400).send({
        error: {
          code: 'VALIDATION_ERROR',
          message: error.errors[0].message,
          details: error.errors
        }
      });
    }

    return reply.code(400).send({
      error: { code: 'INVALID_CODE', message: error.message }
    });
  }
});
```

**Test:**
```bash
# Request reset code
curl -X POST http://localhost:3000/api/v1/auth/solicitar-reset \
  -H "Content-Type: application/json" \
  -d '{"rut":"12.345.678-9"}'

# Expected: {success: true, message: "Si el RUT existe..."}

# Test rate limit (4th request within 15 min should fail)
curl -X POST http://localhost:3000/api/v1/auth/solicitar-reset \
  -H "Content-Type: application/json" \
  -d '{"rut":"12.345.678-9"}'
# Expected: 429 Too Many Requests

# Validate code and reset password
curl -X POST http://localhost:3000/api/v1/auth/validar-reset \
  -H "Content-Type: application/json" \
  -d '{
    "rut": "12.345.678-9",
    "codigo": "123456",
    "password": "NewPass123",
    "confirmPassword": "NewPass123"
  }'
```

**Acceptance Criteria:**
- [ ] 6-digit code sent via WhatsApp
- [ ] 15-minute code expiry
- [ ] Rate limited: 3 requests per RUT per 15 minutes
- [ ] Generic response prevents RUT enumeration (timing attack mitigation)
- [ ] Brute force protection: 5 failed attempts invalidates token
- [ ] Successful reset unlocks account if locked
- [ ] Successful reset invalidates all existing sessions
- [ ] Audit log for all attempts (successful and failed)

---

## Frontend Tasks

### Task 7.5.2: Password Recovery Flow

**Create:** `src/pages/Recuperar.tsx`

```typescript
import { useState } from 'react';
import { useNavigate } from 'react-router';
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';
import { useMutation } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';
import apiClient from '@/lib/api';
import { CheckCircle2, ArrowLeft, Eye, EyeOff } from 'lucide-react';
import { validarRUT, formatearRUT } from '@coab/utils';

// Password validation
const passwordSchema = z
  .string()
  .min(8, 'M√≠nimo 8 caracteres')
  .regex(/[A-Z]/, 'Incluir al menos una may√∫scula')
  .regex(/[a-z]/, 'Incluir al menos una min√∫scula')
  .regex(/[0-9]/, 'Incluir al menos un n√∫mero');

// Step 1: Request code
const requestSchema = z.object({
  rut: z.string().min(1, 'RUT requerido').refine(validarRUT, 'RUT inv√°lido')
});

// Step 2: Validate code and set password
const resetSchema = z.object({
  codigo: z.string().length(6, 'C√≥digo debe ser de 6 d√≠gitos'),
  password: passwordSchema,
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: 'Las contrase√±as no coinciden',
  path: ['confirmPassword']
});

type RequestForm = z.infer<typeof requestSchema>;
type ResetForm = z.infer<typeof resetSchema>;

export default function RecuperarPage() {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [step, setStep] = useState<'request' | 'verify' | 'success'>('request');
  const [rut, setRut] = useState('');
  const [rutDisplay, setRutDisplay] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false);

  // Step 1: Request code form
  const requestForm = useForm<RequestForm>({
    resolver: zodResolver(requestSchema)
  });

  // Step 2: Verify code form
  const resetForm = useForm<ResetForm>({
    resolver: zodResolver(resetSchema)
  });

  const password = resetForm.watch('password', '');

  // Password strength indicators
  const hasMinLength = password.length >= 8;
  const hasUppercase = /[A-Z]/.test(password);
  const hasLowercase = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);

  // Request code mutation
  const requestMutation = useMutation({
    mutationFn: async (data: RequestForm) => {
      const res = await apiClient.post('/auth/solicitar-reset', {
        rut: data.rut
      });
      return res.data;
    },
    onSuccess: () => {
      toast({
        title: 'C√≥digo enviado',
        description: 'Si tu RUT est√° registrado, recibir√°s un c√≥digo por WhatsApp'
      });
      setStep('verify');
    },
    onError: (error: any) => {
      const message = error.response?.data?.error?.message || 'Error al solicitar c√≥digo';
      toast({
        variant: 'destructive',
        title: 'Error',
        description: message
      });
    }
  });

  // Validate code mutation
  const resetMutation = useMutation({
    mutationFn: async (data: ResetForm) => {
      const res = await apiClient.post('/auth/validar-reset', {
        rut: rut,
        codigo: data.codigo,
        password: data.password,
        confirmPassword: data.confirmPassword
      });
      return res.data;
    },
    onSuccess: (data) => {
      setStep('success');
      toast({
        title: 'Contrase√±a actualizada',
        description: 'Ya puedes iniciar sesi√≥n con tu nueva contrase√±a'
      });
    },
    onError: (error: any) => {
      const message = error.response?.data?.error?.message || 'C√≥digo inv√°lido';
      toast({
        variant: 'destructive',
        title: 'Error',
        description: message
      });
    }
  });

  const handleRutChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const formatted = formatearRUT(e.target.value);
    setRutDisplay(formatted);
    const clean = formatted.replace(/[.-]/g, '');
    setRut(clean);
    requestForm.setValue('rut', clean);
  };

  const onRequestSubmit = (data: RequestForm) => {
    requestMutation.mutate(data);
  };

  const onResetSubmit = (data: ResetForm) => {
    resetMutation.mutate(data);
  };

  // Success Screen
  if (step === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6 text-center space-y-4">
            <CheckCircle2 className="h-16 w-16 text-accent-green mx-auto" />
            <h2 className="text-xl font-bold">¬°Contrase√±a Actualizada!</h2>
            <p className="text-gray-600">
              Tu contrase√±a ha sido cambiada exitosamente.
            </p>
            <Button
              onClick={() => navigate(`/login?rut=${encodeURIComponent(formatearRUT(rut))}`)}
              className="w-full h-12 bg-primary-blue hover:bg-blue-700"
            >
              Ir a Iniciar Sesi√≥n
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Step 2: Verify Code
  if (step === 'verify') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <Card className="w-full max-w-md">
          <CardHeader>
            <CardTitle className="text-xl font-bold text-center">
              Verificar C√≥digo
            </CardTitle>
            <p className="text-center text-gray-600 text-sm">
              Ingresa el c√≥digo de 6 d√≠gitos enviado a tu WhatsApp
            </p>
          </CardHeader>
          <CardContent>
            <form onSubmit={resetForm.handleSubmit(onResetSubmit)} className="space-y-4">
              <div>
                <Label htmlFor="codigo">C√≥digo de Verificaci√≥n</Label>
                <Input
                  id="codigo"
                  type="text"
                  inputMode="numeric"
                  maxLength={6}
                  placeholder="123456"
                  {...resetForm.register('codigo')}
                  className={`h-14 text-center text-2xl tracking-widest font-mono ${
                    resetForm.formState.errors.codigo ? 'border-red-500' : ''
                  }`}
                />
                {resetForm.formState.errors.codigo && (
                  <p className="text-sm text-red-500 mt-1">
                    {resetForm.formState.errors.codigo.message}
                  </p>
                )}
              </div>

              <div>
                <Label htmlFor="password">Nueva Contrase√±a</Label>
                <div className="relative">
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    {...resetForm.register('password')}
                    className={`h-12 pr-10 ${
                      resetForm.formState.errors.password ? 'border-red-500' : ''
                    }`}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >
                    {showPassword ? <EyeOff className="h-5 w-5" /> : <Eye className="h-5 w-5" />}
                  </button>
                </div>
              </div>

              {/* Password Requirements */}
              <div className="space-y-1 text-sm">
                <RequirementIndicator met={hasMinLength} text="M√≠nimo 8 caracteres" />
                <RequirementIndicator met={hasUppercase} text="Una letra may√∫scula" />
                <RequirementIndicator met={hasLowercase} text="Una letra min√∫scula" />
                <RequirementIndicator met={hasNumber} text="Un n√∫mero" />
              </div>

              <div>
                <Label htmlFor="confirmPassword">Confirmar Contrase√±a</Label>
                <div className="relative">
                  <Input
                    id="confirmPassword"
                    type={showConfirm ? 'text' : 'password'}
                    {...resetForm.register('confirmPassword')}
                    className={`h-12 pr-10 ${
                      resetForm.formState.errors.confirmPassword ? 'border-red-500' : ''
                    }`}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                  <button
                    type="button"
                    onClick={() => setShowConfirm(!showConfirm)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >
                    {showConfirm ? <EyeOff className="h-5 w-5" /> : <Eye className="h-5 w-5" />}
                  </button>
                </div>
                {resetForm.formState.errors.confirmPassword && (
                  <p className="text-sm text-red-500 mt-1">
                    {resetForm.formState.errors.confirmPassword.message}
                  </p>
                )}
              </div>

              <Button
                type="submit"
                className="w-full h-12 bg-primary-blue hover:bg-blue-700"
                disabled={resetMutation.isPending}
              >
                {resetMutation.isPending ? 'Verificando...' : 'Cambiar Contrase√±a'}
              </Button>

              <Button
                type="button"
                variant="ghost"
                className="w-full"
                onClick={() => setStep('request')}
              >
                ‚Üê Solicitar nuevo c√≥digo
              </Button>
            </form>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Step 1: Request Code
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-xl font-bold text-center">
            Recuperar Contrase√±a
          </CardTitle>
          <p className="text-center text-gray-600 text-sm">
            Ingresa tu RUT para recibir un c√≥digo de recuperaci√≥n
          </p>
        </CardHeader>
        <CardContent>
          <form onSubmit={requestForm.handleSubmit(onRequestSubmit)} className="space-y-4">
            <div>
              <Label htmlFor="rut">RUT</Label>
              <Input
                id="rut"
                type="text"
                inputMode="numeric"
                placeholder="12.345.678-9"
                value={rutDisplay}
                onChange={handleRutChange}
                className={`h-12 text-lg ${
                  requestForm.formState.errors.rut ? 'border-red-500' : ''
                }`}
              />
              {requestForm.formState.errors.rut && (
                <p className="text-sm text-red-500 mt-1">
                  {requestForm.formState.errors.rut.message}
                </p>
              )}
            </div>

            <p className="text-sm text-gray-600">
              Te enviaremos un c√≥digo de 6 d√≠gitos a tu WhatsApp registrado.
            </p>

            <Button
              type="submit"
              className="w-full h-12 bg-primary-blue hover:bg-blue-700"
              disabled={requestMutation.isPending}
            >
              {requestMutation.isPending ? 'Enviando...' : 'Enviar C√≥digo'}
            </Button>

            <Button
              type="button"
              variant="ghost"
              className="w-full"
              onClick={() => navigate('/login')}
            >
              <ArrowLeft className="h-4 w-4 mr-2" />
              Volver a Iniciar Sesi√≥n
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}

// Requirement indicator component
function RequirementIndicator({ met, text }: { met: boolean; text: string }) {
  return (
    <div className={`flex items-center gap-2 ${met ? 'text-accent-green' : 'text-gray-400'}`}>
      {met ? (
        <CheckCircle2 className="h-4 w-4" />
      ) : (
        <div className="h-4 w-4 border rounded-full" />
      )}
      <span>{text}</span>
    </div>
  );
}
```

**Update Router in `src/main.tsx`:**

```typescript
import RecuperarPage from './pages/Recuperar';

// Add to routes
<Route path="/recuperar" element={<RecuperarPage />} />
```

**Test:**
1. Go to `/login` and click "¬øOlvid√≥ su contrase√±a?"
2. Enter RUT
3. Receive WhatsApp code (or see console log in dev)
4. Enter 6-digit code
5. Set new password with requirements
6. Success screen ‚Üí "Ir a Iniciar Sesi√≥n"
7. Login with RUT + new password

**Acceptance Criteria:**
- [ ] "Forgot password" link on login page
- [ ] RUT auto-formats as user types
- [ ] Loading state during code request
- [ ] Code input with numeric keyboard (6 digits)
- [ ] Real-time password requirement indicators
- [ ] Password confirmation validation
- [ ] Success screen with login redirect
- [ ] Back button to request new code
- [ ] RUT pre-filled on login page after reset
- [ ] Works on mobile (iOS Safari, Android Chrome)

---

## Iteration 7.5 Complete! ‚úÖ

**What You Can Test:**
- Complete self-service password recovery flow
- WhatsApp code delivery
- Invalid/expired code handling
- Password complexity enforcement
- Brute force protection (5 attempts max)
- Rate limiting (3 requests per 15 minutes)
- Existing sessions invalidated after reset
- Account unlock on successful reset

**Security Verification:**
1. Try non-existent RUT ‚Üí Generic success (no enumeration)
2. Try 6 wrong codes ‚Üí Token invalidated
3. Try 4 requests in 15 min ‚Üí Rate limit error
4. Check response time is consistent (~1.5s)

**Commit Message:**
```
feat: self-service password recovery via WhatsApp code

Backend (Fastify + Argon2):
- POST /auth/solicitar-reset (request 6-digit code via WhatsApp)
- POST /auth/validar-reset (validate code + set password)
- 15-minute code expiry
- Rate limiting: 3 requests per RUT per 15 minutes
- Brute force protection: 5 failed attempts invalidates token
- Timing attack mitigation: consistent 1.5s response time
- Session invalidation on password change
- Account unlock on successful reset
- Comprehensive audit logging

Frontend (Vite + React Router):
- Multi-step recovery flow (request ‚Üí verify ‚Üí success)
- RUT auto-formatting with numeric keyboard
- 6-digit code input with large touch targets
- Real-time password requirement indicators
- Success screen with login redirect

üöÄ Generated with Claude Code
```
